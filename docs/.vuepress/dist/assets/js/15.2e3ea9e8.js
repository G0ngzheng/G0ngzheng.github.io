(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{371:function(s,t,a){"use strict";a.r(t);var n=a(26),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),a("p",[s._v("写完上一篇文章"),a("a",{attrs:{href:"https://juejin.im/post/5d25ce36f265da1ba84ab97a",target:"_blank",rel:"noopener noreferrer"}},[s._v("想学 Node.js，stream 先有必要搞清楚"),a("OutboundLink")],1),s._v("\n留下了悬念，"),a("code",[s._v("stream")]),s._v("对象数据流转的具体内容是什么？本篇文章将为大家进行深入讲解。")]),s._v(" "),a("h2",{attrs:{id:"buffer-探究"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#buffer-探究"}},[s._v("#")]),s._v(" Buffer 探究")]),s._v(" "),a("p",[s._v("看一段之前使用"),a("code",[s._v("stream")]),s._v("操作文件的例子：")]),s._v(" "),a("div",{staticClass:"language-JavaScript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" fileName "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("__dirname"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'data.txt'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" stream"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("createReadStream")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fileName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'stream内容'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("stream"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nstream"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'data'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("chunk")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("chunk "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("instanceof")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Buffer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("chunk"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("看一下打印结果，发现第一个 stream 是一个对象 ，截图部分内容。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2019/7/17/16bfd60a4f3b2069?w=872&h=722&f=jpeg&s=101462",alt:""}}),s._v("\n第二个和第三个打印结果，")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2019/7/17/16bfd601607b160c?w=1372&h=80&f=jpeg&s=34184",alt:""}}),s._v("\nBuffer 对象，类似数组，它的元素为 16 进制的两位数，即 0 到 255 的数值。可以看出 stream 中流动的数据是 Buffer 类型，二进制数据，接下来开始我们的 Buffer 探索之旅。")]),s._v(" "),a("h2",{attrs:{id:"什么是二进制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么是二进制"}},[s._v("#")]),s._v(" 什么是二进制")]),s._v(" "),a("p",[s._v("二进制是计算机最底层的数据格式，字符串，数字，视频，音频，程序，网络包等，在最底层都是用二进制来进行存储。这些高级格式和二进制之间，都可以通过固定的编码格式进行相互转换。")]),s._v(" "),a("p",[s._v("例如，C 语言中 int32 类型的十进制整数（无符号），就占用 32bit 即 4byte，十进制的 3 对应的二进制就是"),a("code",[s._v("00000000 00000000 00000000 00000011")]),s._v("。字符串也是同理，可以根据 ASCII 编码规则或者 unicode 编码规则（如 utf-8）等和二进制进行相互转换。总之，计算机底层存储的数据都是二进制格式，各种高级类型都有对应的编码规则和二进制进行相互转换。")]),s._v(" "),a("h2",{attrs:{id:"node-中为什么会出现-buffer-这个模块"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-中为什么会出现-buffer-这个模块"}},[s._v("#")]),s._v(" node 中为什么会出现 Buffer 这个模块")]),s._v(" "),a("p",[s._v("在最初的"),a("code",[s._v("javascript")]),s._v("生态中，"),a("code",[s._v("javascript")]),s._v("还运行在浏览器端，对于处理 Unicode 编码的字符串数据很容易，但是对于处理二进制以及非"),a("code",[s._v("Unicode")]),s._v("编码的数据无能为力，但是对于"),a("code",[s._v("Server")]),s._v("端操作"),a("code",[s._v("TCP/HTTP")]),s._v("以及"),a("code",[s._v("文件I/O")]),s._v("的处理是必须的。我想就是因此在"),a("code",[s._v("Node.js")]),s._v("里面提供了"),a("code",[s._v("Buffer")]),s._v("类处理二进制的数据，可以处理各种类型的数据。")]),s._v(" "),a("p",[s._v("Buffer 模块的一个说明。")]),s._v(" "),a("blockquote",[a("p",[s._v("在 Node.js 里面一些重要模块 net、http、fs 中的数据传输以及处理都有 Buffer 的身影，因为一些基础的核心模块都要依赖 Buffer，所以在 node 启动的时候，就已经加载了 Buffer，我们可以在全局下面直接使用 Buffer，无需通过 require()。且 Buffer 的大小在创建时确定，无法调整。")])]),s._v(" "),a("h2",{attrs:{id:"buffer-创建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#buffer-创建"}},[s._v("#")]),s._v(" Buffer 创建")]),s._v(" "),a("p",[s._v("在 "),a("code",[s._v("NodeJS v6.0.0")]),s._v("版本之前，"),a("code",[s._v("Buffer")]),s._v("实例是通过 Buffer 构造函数创建的，即使用 new 关键字创建，它根据提供的参数返回不同的 Buffer，但在之后的版本中这种声明方式就被废弃了，替代 new 的创建方式主要有以下几种。")]),s._v(" "),a("h4",{attrs:{id:"_1-buffer-alloc-和-buffer-allocunsafe-创建固定大小的-buffer"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-buffer-alloc-和-buffer-allocunsafe-创建固定大小的-buffer"}},[s._v("#")]),s._v(" 1. Buffer.alloc 和 Buffer.allocUnsafe(创建固定大小的 buffer)")]),s._v(" "),a("p",[s._v("用 "),a("code",[s._v("Buffer.alloc")]),s._v(" 和 "),a("code",[s._v("Buffer.allocUnsafe")]),s._v(" 创建 Buffer 的传参方式相同，参数为创建 Buffer 的长度，数值类型。")]),s._v(" "),a("div",{staticClass:"language-JavaScript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Buffer.alloc 和 Buffer.allocUnsafe 创建 Buffer")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Buffer.alloc 创建 Buffer,创建一个大小为6字节的空buffer，经过了初始化")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("let")]),s._v(" buf1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Buffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("alloc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Buffer.allocUnsafe 创建 Buffer，创建一个大小为6字节的buffer，未经过初始化")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("let")]),s._v(" buf2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Buffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("allocUnsafe")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("buf1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// <Buffer 00 00 00 00 00 00>")]),s._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("buf2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// <Buffer 00 e7 8f a0 00 00>")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("通过代码可以看出，用 "),a("code",[s._v("Buffer.alloc")]),s._v(" 和 "),a("code",[s._v("Buffer.allocUnsafe")]),s._v(" 创建"),a("code",[s._v("Buffer")]),s._v(" 是有区别的，"),a("code",[s._v("Buffer.alloc")]),s._v(" 创建的 "),a("code",[s._v("Buffer")]),s._v(" 是被初始化过的，即 "),a("code",[s._v("Buffer")]),s._v(" 的每一项都用 00 填充，而 "),a("code",[s._v("Buffer.allocUnsafe")]),s._v(" 创建的 Buffer 并没有经过初始化，在内存中只要有闲置的 Buffer 就直接 “抓过来” 使用。")]),s._v(" "),a("p",[a("code",[s._v("Buffer.allocUnsafe")]),s._v(" 创建 "),a("code",[s._v("Buffer")]),s._v(" 使得内存的分配非常快，但已分配的内存段可能包含潜在的敏感数据，有明显性能优势的同时又是不安全的，所以使用需格外 “小心”。")]),s._v(" "),a("h4",{attrs:{id:"_2、buffer-from-根据内容直接创建-buffer"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2、buffer-from-根据内容直接创建-buffer"}},[s._v("#")]),s._v(" 2、Buffer.from(根据内容直接创建 Buffer)")]),s._v(" "),a("blockquote",[a("p",[s._v("Buffer.from(str, )\n支持三种传参方式：")])]),s._v(" "),a("ul",[a("li",[s._v("第一个参数为字符串，第二个参数为字符编码，如 "),a("code",[s._v("ASCII")]),s._v("、"),a("code",[s._v("UTF-8")]),s._v("、"),a("code",[s._v("Base64")]),s._v(" 等等。")]),s._v(" "),a("li",[s._v("传入一个数组，数组的每一项会以十六进制存储为 "),a("code",[s._v("Buffer")]),s._v(" 的每一项。")]),s._v(" "),a("li",[s._v("传入一个"),a("code",[s._v("Buffer")]),s._v("，会将 "),a("code",[s._v("Buffer")]),s._v(" 的每一项作为新返回 "),a("code",[s._v("Buffer")]),s._v(" 的每一项。")])]),s._v(" "),a("p",[a("strong",[s._v("说明:"),a("code",[s._v("Buffer")]),s._v("目前支持的编码格式")])]),s._v(" "),a("ul",[a("li",[s._v("ascii - 仅支持 7 位 ASCII 数据。")]),s._v(" "),a("li",[s._v("utf8 - 多字节编码的 Unicode 字符")]),s._v(" "),a("li",[s._v("utf16le - 2 或 4 个字节，小端编码的 Unicode 字符")]),s._v(" "),a("li",[s._v("base64 - Base64 字符串编码")]),s._v(" "),a("li",[s._v("binary - 二进制编码。")]),s._v(" "),a("li",[s._v("hex - 将每个字节编码为两个十六进制字符。")])]),s._v(" "),a("h5",{attrs:{id:"传入字符串和字符编码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#传入字符串和字符编码"}},[s._v("#")]),s._v(" 传入字符串和字符编码：")]),s._v(" "),a("div",{staticClass:"language-JavaScript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 传入字符串和字符编码")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("let")]),s._v(" buf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Buffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("from")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"utf8"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("buf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// <Buffer 68 65 6c 6c 6f>")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h5",{attrs:{id:"传入数组"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#传入数组"}},[s._v("#")]),s._v(" 传入数组：")]),s._v(" "),a("div",{staticClass:"language-JavaScript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 数组成员为十进制数")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("let")]),s._v(" buf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Buffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("from")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("buf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// <Buffer 01 02 03>")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("div",{staticClass:"language-JavaScript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 数组成员为十六进制数")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("let")]),s._v(" buf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Buffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("from")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0xe4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0xbd")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0xa0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0xe5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0xa5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0xbd")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("buf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// <Buffer e4 bd a0 e5 a5 bd>")]),s._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("buf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("toString")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"utf8"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 你好")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("在 "),a("code",[s._v("NodeJS")]),s._v(" 中不支持 "),a("code",[s._v("GB2312")]),s._v(" 编码，默认支持 "),a("code",[s._v("UTF-8")]),s._v("，在 "),a("code",[s._v("GB2312")]),s._v(" 中，一个汉字占两个字节，而在 "),a("code",[s._v("UTF-8")]),s._v(" 中，"),a("code",[s._v("一个汉字")]),s._v("占三个字节，所以上面 “你好” 的 "),a("code",[s._v("Buffer")]),s._v(" 为 6 个十六进制数组成。")]),s._v(" "),a("div",{staticClass:"language-JavaScript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 数组成员为字符串类型的数字")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("let")]),s._v(" buf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Buffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("from")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("buf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// <Buffer 01 02 03>")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("传入的数组成员可以是任何进制的数值，当成员为字符串的时候，如果值是数字会被自动识别成数值类型，如果值不是数字或成员为是其他非数值类型的数据，该成员会被初始化为 00。")]),s._v(" "),a("p",[s._v("创建的 "),a("code",[s._v("Buffer")]),s._v(" 可以通过 "),a("code",[s._v("toString")]),s._v(" 方法直接指定编码进行转换，默认编码为 "),a("code",[s._v("UTF-8")]),s._v("。")]),s._v(" "),a("h5",{attrs:{id:"传入-buffer"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#传入-buffer"}},[s._v("#")]),s._v(" 传入 Buffer：")]),s._v(" "),a("div",{staticClass:"language-JavaScript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 传入一个 Buffer")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("let")]),s._v(" buf1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Buffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("from")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"utf8"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("let")]),s._v(" buf2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Buffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("from")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("buf1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("buf1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// <Buffer 68 65 6c 6c 6f>")]),s._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("buf2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// <Buffer 68 65 6c 6c 6f>")]),s._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("buf1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),s._v(" buf2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// false")]),s._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("buf1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),s._v(" buf2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// true")]),s._v("\nbuf1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("buf1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// <Buffer 68 0c 6c 6c 6f>")]),s._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("buf2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// <Buffer 68 65 6c 6c 6f>")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("当传入的参数为一个 "),a("code",[s._v("Buffer")]),s._v(" 的时候，会创建一个新的 "),a("code",[s._v("Buffer")]),s._v(" 并复制上面的每一个成员。")]),s._v(" "),a("p",[a("code",[s._v("Buffer")]),s._v(" 为引用类型，一个 "),a("code",[s._v("Buffer")]),s._v(" 复制了另一个 Buffer 的成员，当其中一个 Buffer 复制的成员有更改，另一个 Buffer 对应的成员不会跟着改变，说明传入"),a("code",[s._v("buffer")]),s._v("创建新的"),a("code",[s._v("Buffer")]),s._v("的时候是一个深拷贝的过程。")]),s._v(" "),a("h2",{attrs:{id:"buffer-的内存分配机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#buffer-的内存分配机制"}},[s._v("#")]),s._v(" Buffer 的内存分配机制")]),s._v(" "),a("p",[a("strong",[s._v("buffer 对应于 V8 堆内存之外的一块原始内存")])]),s._v(" "),a("p",[a("code",[s._v("Buffer")]),s._v("是一个典型的"),a("code",[s._v("javascript")]),s._v("与"),a("code",[s._v("C++")]),s._v("结合的模块，与性能有关的用 C++来实现，"),a("code",[s._v("javascript")]),s._v(" 负责衔接和提供接口。"),a("code",[s._v("Buffer")]),s._v("所占的内存不是"),a("code",[s._v("V8")]),s._v("堆内存，是独立于"),a("code",[s._v("V8")]),s._v("堆内存之外的内存，通过"),a("code",[s._v("C++")]),s._v("层面实现内存申请（可以说真正的内存是"),a("code",[s._v("C++")]),s._v("层面提供的）、"),a("code",[s._v("javascript")]),s._v(" 分配内存（可以说"),a("code",[s._v("JavaScript")]),s._v("层面只是使用它）。"),a("code",[s._v("Buffer")]),s._v("在分配内存最终是使用"),a("code",[s._v("ArrayBuffer")]),s._v("对象作为载体。简单点而言， 就是"),a("code",[s._v("Buffer")]),s._v("模块使用"),a("code",[s._v("v8::ArrayBuffer")]),s._v("分配一片内存，通过"),a("code",[s._v("TypedArray")]),s._v("中的"),a("code",[s._v("v8::Uint8Array")]),s._v("来去写数据。")]),s._v(" "),a("h4",{attrs:{id:"内存分配的-8k-机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#内存分配的-8k-机制"}},[s._v("#")]),s._v(" 内存分配的 8K 机制")]),s._v(" "),a("ul",[a("li",[s._v("分配小内存")])]),s._v(" "),a("p",[s._v("说道 Buffer 的内存分配就不得不说"),a("code",[s._v("Buffer")]),s._v("的"),a("code",[s._v("8KB")]),s._v("的问题，对应"),a("code",[s._v("buffer.js")]),s._v("源码里面的处理如下：")]),s._v(" "),a("div",{staticClass:"language-JavaScript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[s._v("Buffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("poolSize "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("allocate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("size "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("FastBuffer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("size "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" Buffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("poolSize "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("size "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" poolSize "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" poolOffset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("createPool")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" b "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" allocPool"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("slice")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("poolOffset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("poolOffset "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        poolOffset "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("alignPool")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" b\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("createUnsafeBuffer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[s._v("源码直接看来就是以 8KB 作为界限，如果写入的数据大于 8KB 一半的话直接则直接去分配内存，如果小于 4KB 的话则从当前分配池里面判断是否够空间放下当前存储的数据，如果不够则重新去申请 8KB 的内存空间，把数据存储到新申请的空间里面，如果足够写入则直接写入数据到内存空间里面，下图为其内存分配策略。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2019/7/16/16bfa9c8e4af644f?w=664&h=446&f=png&s=29461",alt:"Buffer内存分配策略图"}}),s._v("\n看内存分配策略图，如果当前存储了 2KB 的数据，后面要存储 5KB 大小数据的时候分配池判断所需内存空间大于 4KB，则会去重新申请内存空间来存储 5KB 数据并且分配池的当前偏移指针也是指向新申请的内存空间，这时候就之前剩余的 6KB(8KB-2KB)内存空间就会被搁置。至于为什么会用"),a("code",[s._v("8KB")]),s._v("作为"),a("code",[s._v("存储单元")]),s._v("分配，为什么大于"),a("code",[s._v("8KB")]),s._v("按照大内存分配策略，在下面"),a("code",[s._v("Buffer")]),s._v("内存分配机制优点有说明。")]),s._v(" "),a("ul",[a("li",[s._v("分配大内存")])]),s._v(" "),a("p",[s._v("还是看上面那张内存分配图，如果需要超过"),a("code",[s._v("8KB")]),s._v("的"),a("code",[s._v("Buffer")]),s._v("对象，将会直接分配一个"),a("code",[s._v("SlowBuffer")]),s._v("对象作为基础单元，这个基础单元将会被这个大"),a("code",[s._v("Buffer")]),s._v("对象独占。")]),s._v(" "),a("div",{staticClass:"language-JavaScript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Big buffer,just alloc one")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("parent "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SlowBuffer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("length"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("offset "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("这里的"),a("code",[s._v("SlowBUffer")]),s._v("类实在"),a("code",[s._v("C++")]),s._v("中定义的，虽然引用 buffer 模块可以访问到它，但是不推荐直接操作它，而是用"),a("code",[s._v("Buffer")]),s._v("替代。这里内部"),a("code",[s._v("parent")]),s._v("属性指向的"),a("code",[s._v("SlowBuffer")]),s._v("对象来自"),a("code",[s._v("Node")]),s._v("自身"),a("code",[s._v("C++")]),s._v("中的定义，是"),a("code",[s._v("C++")]),s._v("层面的"),a("code",[s._v("Buffer")]),s._v("对象，所用内存不在"),a("code",[s._v("V8")]),s._v("的堆中")]),s._v(" "),a("ul",[a("li",[s._v("内存分配的限制")])]),s._v(" "),a("p",[s._v("此外，"),a("code",[s._v("Buffer")]),s._v("单次的内存分配也有限制，而这个限制根据不同操作系统而不同，而这个限制可以看到"),a("code",[s._v("node_buffer.h")]),s._v("里面")]),s._v(" "),a("div",{staticClass:"language-C line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[s._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("unsigned")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" kMaxLength "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("int32_t")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("intptr_t")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x3fffffff")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x7fffffff")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("对于 32 位的操作系统单次可最大分配的内存为 1G，对于 64 位或者更高的为 2G。")]),s._v(" "),a("h4",{attrs:{id:"buffer-内存分配机制优点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#buffer-内存分配机制优点"}},[s._v("#")]),s._v(" buffer 内存分配机制优点")]),s._v(" "),a("p",[a("code",[s._v("Buffer")]),s._v("真正的内存实在"),a("code",[s._v("Node")]),s._v("的"),a("code",[s._v("C++")]),s._v("层面提供的，"),a("code",[s._v("JavaScript")]),s._v("层面只是使用它。当进行小而频繁的"),a("code",[s._v("Buffer")]),s._v("操作时，采用的是"),a("code",[s._v("8KB")]),s._v("为一个单元的机制进行预先申请和事后分配，使得"),a("code",[s._v("Javascript")]),s._v("到操作系统之间不必有过多的内存申请方面的系统调用。对于大块的"),a("code",[s._v("Buffer")]),s._v("而言(大于"),a("code",[s._v("8KB")]),s._v(")，则直接使用"),a("code",[s._v("C++")]),s._v("层面提供的内存，则无需细腻的分配操作。")]),s._v(" "),a("h2",{attrs:{id:"buffer-与-stream"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#buffer-与-stream"}},[s._v("#")]),s._v(" Buffer 与 stream")]),s._v(" "),a("h4",{attrs:{id:"stream-的流动为什么要使用二进制-buffer"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#stream-的流动为什么要使用二进制-buffer"}},[s._v("#")]),s._v(" stream 的流动为什么要使用二进制 Buffer")]),s._v(" "),a("p",[s._v("根据最初代码的打印结果，"),a("code",[s._v("stream")]),s._v("中流动的数据就是"),a("code",[s._v("Buffer")]),s._v("类型，也就是"),a("code",[s._v("二进制")]),s._v("。")]),s._v(" "),a("p",[a("strong",[s._v("原因一：")])]),s._v(" "),a("p",[a("code",[s._v("node")]),s._v("官方使用二进制作为数据流动肯定是考虑过很多，比如在上一篇 "),a("a",{attrs:{href:"https://juejin.im/post/5d25ce36f265da1ba84ab97a",target:"_blank",rel:"noopener noreferrer"}},[s._v("想学 Node.js，stream 先有必要搞清楚"),a("OutboundLink")],1),s._v("文章已经说过，stream 主要的设计目的——是为了优化"),a("code",[s._v("IO操作")]),s._v("（"),a("code",[s._v("文件IO")]),s._v("和"),a("code",[s._v("网络IO")]),s._v("），对应后端无论是"),a("code",[s._v("文件IO")]),s._v("还是"),a("code",[s._v("网络IO")]),s._v("，其中包含的数据格式都是未知的，有可能是字符串，音频，视频，网络包等等，即使就是字符串，它的编码格式也是未知的，可能"),a("code",[s._v("ASC编码")]),s._v("，也可能"),a("code",[s._v("utf-8")]),s._v("编码，对于这些未知的情况，还不如直接使用最通用的格式"),a("code",[s._v("二进制")]),s._v(".")]),s._v(" "),a("p",[a("strong",[s._v("原因二：")])]),s._v(" "),a("p",[a("code",[s._v("Buffer")]),s._v("对于"),a("code",[s._v("http")]),s._v("请求也会带来性能提升。")]),s._v(" "),a("p",[s._v("举一个例子：")]),s._v(" "),a("div",{staticClass:"language-JavaScript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" http "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'http'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" fs "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'fs'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" path "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'path'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" server "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("createServer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" res")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" fileName "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("__dirname"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'buffer-test.txt'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("readFile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fileName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" data")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 测试1 ：直接返回二进制数据")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// res.end(data.toString())  // 测试2 ：返回字符串数据")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nserver"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("listen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("将代码中的"),a("code",[s._v("buffer-test")]),s._v("文件大小增加到"),a("code",[s._v("50KB")]),s._v("左右，然后使用"),a("code",[s._v("ab")]),s._v("工具测试一下性能，你会发现无论是从"),a("code",[s._v("吞吐量")]),s._v("（Requests per second）还是连接时间上，返回二进制格式比返回字符串格式效率提高很多。为何字符串格式效率低？—— 因为网络请求的数据本来就是二进制格式传输，虽然代码中写的是 "),a("code",[s._v("response")]),s._v(" 返回字符串，最终还得再转换为二进制进行传输，多了一步操作，效率当然低了。")]),s._v(" "),a("h4",{attrs:{id:"buffer-在-stream-数据流转充当的角色"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#buffer-在-stream-数据流转充当的角色"}},[s._v("#")]),s._v(" Buffer 在 stream 数据流转充当的角色")]),s._v(" "),a("p",[s._v("我们可以把整个"),a("code",[s._v("流(stream)")]),s._v("和"),a("code",[s._v("Buffer")]),s._v("的配合过程看作"),a("code",[s._v("公交站")]),s._v("。在一些公交站，"),a("code",[s._v("公交车")]),s._v("在没有装满乘客前是不会发车的，或者在特定的时刻才会发车。当然，乘客也可能在不同的时间，人流量大小也会有所不同，有人多的时候，有人少的时候，"),a("code",[s._v("乘客")]),s._v("或"),a("code",[s._v("公交车站")]),s._v("都无法控制人流量。")]),s._v(" "),a("p",[s._v("不论何时，早到的乘客都必须等待，直到"),a("code",[s._v("公交车")]),s._v("接到指令可以发车。当乘客到站，发现"),a("code",[s._v("公交车")]),s._v("已经装满，或者已经开走，他就必须等待下一班车次。")]),s._v(" "),a("p",[s._v("总之，这里总会有一个等待的地方，这个"),a("code",[s._v("等待的区域")]),s._v("就是"),a("code",[s._v("Node.js")]),s._v("中的"),a("code",[s._v("Buffer")]),s._v("，"),a("code",[s._v("Node.js")]),s._v("不能控制数据什么时候传输过来，传输速度，就好像公交车站无法控制人流量一样。他只能决定什么时候发送数据(公交车发车)。如果时间还不到，那么"),a("code",[s._v("Node.js")]),s._v("就会把数据放入"),a("code",[s._v("Buffer")]),s._v("等待区域中，一个在 RAM 中的地址，直到把他们发送出去进行处理。")]),s._v(" "),a("p",[a("strong",[s._v("注意点：")])]),s._v(" "),a("p",[a("code",[s._v("Buffer")]),s._v("虽好也不要瞎用，"),a("code",[s._v("Buffer")]),s._v("与"),a("code",[s._v("String")]),s._v("两者都可以存储字符串类型的数据，但是，"),a("code",[s._v("String")]),s._v("与"),a("code",[s._v("Buffer")]),s._v("不同，在内存分配上面，"),a("code",[s._v("String")]),s._v("直接使用"),a("code",[s._v("v8堆存储")]),s._v("，不用经过"),a("code",[s._v("c++")]),s._v("堆外分配内存，并且"),a("code",[s._v("Google")]),s._v("也对"),a("code",[s._v("String")]),s._v("进行优化，在实际的拼接测速对比中，"),a("code",[s._v("String")]),s._v("比"),a("code",[s._v("Buffer")]),s._v("快。但是"),a("code",[s._v("Buffer")]),s._v("的出现是为了处理二进制以及其他非"),a("code",[s._v("Unicode")]),s._v("编码的数据，所以在处理"),a("code",[s._v("非utf8")]),s._v("数据的时候需要使用到"),a("code",[s._v("Buffer")]),s._v("来处理。")])])}),[],!1,null,null,null);t.default=e.exports}}]);